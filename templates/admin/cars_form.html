{% extends "base.html" %}
{% block title %}{{ 'Edit' if car else 'Add' }} Car{% endblock %}
{% block content %}

<h1>{{ 'Edit' if car else 'Add' }} Car</h1>
<form method="post" enctype="multipart/form-data" class="car-form">
  <div class="grid-3">
    <input name="title" placeholder="Title" value="{{ car.title if car else '' }}" required>
    <input name="make" placeholder="Make" value="{{ car.make if car else '' }}">
    <input name="model" placeholder="Model" value="{{ car.model if car else '' }}">
  </div>
  <div class="grid-4">
    <input type="number" name="year" placeholder="Year" value="{{ car.year if car else '' }}">
    <input type="number" name="price" placeholder="Price" value="{{ car.price if car else '' }}">
    <input type="number" name="mileage_km" placeholder="Mileage (km)" value="{{ car.mileage_km if car else '' }}">
    <input name="color" placeholder="Color" value="{{ car.color if car else '' }}">
  </div>
  <div class="grid-4">
    <input name="fuel_type" placeholder="Fuel (Petrol/Diesel/Hybrid/Electric)"
      value="{{ car.fuel_type if car else '' }}">
    <input name="transmission" placeholder="Transmission" value="{{ car.transmission if car else '' }}">
    <input name="body_type" placeholder="Body Type" value="{{ car.body_type if car else '' }}">
    <input name="location" placeholder="Location" value="{{ car.location if car else '' }}">
  </div>

<label>Upload Images (max 10)</label>

<input type="file" name="image_files" id="image_files" accept="image/*" multiple>

<div id="multi_preview" class="preview-grid" style="margin-top:8px;"></div>
<div class="small muted" id="count_hint" style="margin-top:6px;">0 / 10 selected</div>

<script>
  // Live preview + client-side limit of 10
  const input = document.getElementById('image_files');
  const grid  = document.getElementById('multi_preview');
  const count = document.getElementById('count_hint');

  input.addEventListener('change', () => {
    const files = Array.from(input.files || []);
    if (files.length > 10) {
      alert('Please select at most 10 images.');
      input.value = '';       // clear selection
      grid.innerHTML = '';
      count.textContent = '0 / 10 selected';
      return;
    }
    grid.innerHTML = '';
    files.forEach(f => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.style.height = '100px';
      img.style.objectFit = 'cover';
      img.style.border = '1px solid #333';
      img.style.borderRadius = '6px';
      img.style.marginRight = '8px';
      grid.appendChild(img);
    });
    count.textContent = files.length + ' / 10 selected';
  });
</script>



{% if car %}
  <!-- Existing cover image preview (what dashboard uses) -->
  <div class="preview" style="margin:8px 0 14px;">
    <img
      id="cover_preview"
      src="{{ car.image_url or url_for('static', filename='img/placeholder.svg') }}"
      alt="Current cover image"
      style="max-height:120px"
    >
  </div>

  {% if car.images %}
    <!-- Existing gallery thumbnails -->
    <div class="gallery" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
      {% for img in car.images %}
        <img src="{{ img.url }}" alt="car image" style="max-height:90px;border:1px solid #333;border-radius:6px;">
      {% endfor %}
    </div>
  {% endif %}
{% endif %}

<script>
  // Live preview for each of the 5 inputs
  for (let i = 1; i <= 5; i++) {
    const input = document.getElementById('image_file' + i);
    const img   = document.getElementById('slot' + i);
    const label = document.getElementById('slot' + i + '_name');
    if (!input) continue;

    input.addEventListener('change', (e) => {
      const [file] = e.target.files || [];
      if (!file) {
        img.style.display = 'none';
        img.src = '';
        if (label) label.textContent = '';
        return;
      }
      img.src = URL.createObjectURL(file);
      img.style.display = 'inline-block';
      if (label) label.textContent = file.name;
      // also update the big cover preview if it's still placeholder
      const cover = document.getElementById('cover_preview');
      if (cover && (cover.src.includes('placeholder.svg') || !cover.src)) {
        cover.src = img.src;
      }
    });
  }
</script>


  <button>{{ 'Update' if car else 'Create' }}</button>
</form>

{% if car and car.images %}
  <h3 style="margin-top:1rem;">Existing Images</h3>
  <div class="gallery" style="display:flex; gap:12px; flex-wrap:wrap;">
    {% for img in car.images %}
      <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
        <img src="{{ img.url }}" alt="car image"
             style="height:90px; width:auto; object-fit:cover; border:1px solid #333; border-radius:6px;">
        <form method="post"
              action="{{ url_for('admin_car_image_delete', car_id=car.id, image_id=img.id) }}"
              onsubmit="return confirm('Delete this image?')">
          <button class="btn small danger" type="submit">Delete</button>
        </form>
      </div>
    {% endfor %}
  </div>
{% endif %}



{% endblock %}